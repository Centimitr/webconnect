<!doctype html>
<html>
	<head></head>
	<body>
		<script type="text/javascript">
			class Webconnect {
				constructor(url){
				this.url = url;
				this.websocket;
				this.protocol;
				this.sendBuffer = [];
				// this.waitingSet = new Set();
				this.waitingSet = [];
				this.receiveBuffer = [];
				this._connect();
			};
			// websocket original methods
			_sendAndClearBuffer(){
				while (this.sendBuffer.length) {
					this._send(this.sendBuffer.pop());
				}
			};
			_send(data){
				this.websocket.send(data);
			};
			send(data){
				console.log('Sending.');
				this.sendBuffer.push(data);
				return new Promise((resolve,reject)=>{
					var w = {};
					w.onreceive = function(data){
						resolve(data);
						return;
					};
					this.waitingSet.push(w);
					setTimeout(function() {
						reject('Timeout.');
					}, 2000);
				})
			};
			receive(){
				return this.receiveBuffer.pop();
			};
			// connection
			_connect(){
				console.log('SOCKET: Start.');
				this.websocket = new WebSocket(this.url)
				console.log(this.websocket);
				this.websocket.onopen = function(event){
					console.log('SOCKET: Open.',event);
					console.log('SOCKET: Send.');
					event.target.send(123);
				};
				this.websocket.onmessage = function(event){
				console.log('SOCKET: Message.',event);
				if (event.data==='123456') {
					this.waitingSet[0].onreceive();
				}
					// this.receiveBuffer.push(event.data);
				};
			};
			disconnect(){
				this.websocket.close();
				console.log('SOCKET: Close.');
			};
		}
		var c = new Webconnect('ws://localhost:12345/echo');
		c.send(123456).then((json)=>{
			console.log('Data received',json);
		},(error)=>{
			console.log('Receive error',error);
		});
		setTimeout(function(){
			c.disconnect();
		}, 4000)
		</script>
	</body>
</html>
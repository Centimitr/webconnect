<!doctype html>
<html>
	<head></head>
	<body>
		<script type="text/javascript">
		class Task {
	   		constructor(id,method, params, data){
	   			this.id = id;
	   			this.status = 'queued';
	   			this.request = {
	   				id: this.id || Date.now(),
	   				method: method || "",
	   				params: params || {},
	   				data: data || {}
	   			}
	   		}
	   		isQueued(){
	   			return this.status === 'queued';
	   		}
	   		isSent(){
	   			return this.status === 'sent';
	   		}
	   		setSent(){
	   			this.status='sent';
	   		}
	   		onreceive(){}
	   	}
		class Webconnect {
			constructor(url){
				// websocket
				this.url = url;
				this.websocket;
				// webconnct
				this._order = 0;
				this.queue = [];
				this.REQUEST_TIMEOUT = 3000;
				// this.CONNECTION_TIMEOUT = 4000;
				this._connect();
			};
			_isConnected(){
				return this.websocket && this.websocket.readyState === 1;
			};
			_sendQueueRequests(){
				if (this._isConnected()) {
					this.queue.map((w)=>{
						if (w.isQueued()) {
							this.websocket.send(JSON.stringify(w.request));
							w.setSent();
						}
					});
				}else {
				}
			}
			call(method, params, data){
				return new Promise((resolve,reject)=>{
					// add new task
					let w = new Task((this._order++)+'.'+method,method,params,data);
					// let w = new Task(method,method,params,data);
					w.onreceive = function(data){
						resolve(data);
						return;
					};
					console.log('METHOD: Send.');
					this.queue.push(w);
					// do task in queue
					this._sendQueueRequests();
					// timeout
					setTimeout(function() {
						reject('Timeout.');
					}, this.REQUEST_TIMEOUT);
				})
			}
			// connection
			_connect(){
				console.log('SOCKET: New.');
				this.websocket = new WebSocket(this.url)
				this.websocket.onopen = (event)=>{
					// this.isConnected = true;
					console.log('SOCKET: Open.');
					// send all requests in queue
					console.log('SOCKET: Start Clearing the Queue.');
					this._sendQueueRequests();
				};
				this.websocket.onmessage = (event)=>{
					console.log('SOCKET: Message.');
					let data = JSON.parse(event.data);
					let havntMatch = true;
					this.queue.map((w,i)=>{	
						if(havntMatch && w.id===data.id){
							console.log("METHOD: Catch matched response: "+w.id);
							w.onreceive(data);
							this.queue.splice(i,1);
							havntMatch = false;
						}
					})
				};
				this.websocket.onclose = ()=>{
					// this.isConnected = false;
				};
			};
			disconnect(){
				this.websocket.close();
				// this.isConnected = false;
				console.log('SOCKET: Close.');
			};
		}
		// have a try
		var c = new Webconnect('ws://localhost:12345/echo');
		setInterval(function(){
			let i = 100;
			while (i--) {
			c.call('getIndexArticles',{},{}).then((json)=>{
				// console.log('--USER: Response received.\n',json);
				console.log('--USER: Response received.');
			},(error)=>{
				console.log('--USER: Receive error:',error);
			});
			}
		}, 1000);
		</script>
	</body>
</html>